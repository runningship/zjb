<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<title></title>
<meta name="description" content="">
<meta name="keywords" content="">
<meta name="viewport" content="width=device-width,user-scalable=no" />   
<link href="../css/reset.css" rel="stylesheet">
<link href="../css/style.css" rel="stylesheet">
<script src="../js/jquery.min.js" type="text/javascript"></script>
<script src="../js/common.js" type="text/javascript"></script>
<script type="text/javascript" src="../js/buildHtml.js"></script>
<script type="text/javascript" src="../js/echo.js"></script>
<style type="text/css">
.mainer img{background:#FFF url(../images/ajax.gif) no-repeat center center}
</style>
<script type="text/javascript">
function ImgAutoBox(img){
    function imgAct(){
        var ThiW=Thi.width(),
        ThiH=Thi.height(),
        isW='W',
        ThiP=Thi.parent(),
        ThiPW=ThiP.width(),
        ThiPH=ThiP.height();
        if(ThiH>ThiW){isW='H'}
        if(isW=='W'){
            Thi.css({
                'height': ThiPH,
                'width': 'auto'
                
            });
            ThiWn=(Thi.width()-ThiPW)/2;
            Thi.css({'margin-left':-ThiWn})
        }else{
            Thi.css({
                'width': ThiPW,
                'height': 'auto'
            });
            ThiHn=(Thi.height()-ThiPH)/2;
            Thi.css({'margin-top':-ThiHn})
        }
        ThiP.css('overflow', 'hidden');
    }
    var Thi=img;
    var img = new Image(); 
    img.src =Thi.attr("src");
    if(img.complete){
        imgAct();
    }else{
        img.onload = function(){
            imgAct();
        }
    }
}
function ImgListBox(a){
    if(!a){a=$('.ImgListBox')}
    var Thi=a,
    ThiLi=Thi.children('li');
    ThiLi.each(function(index, el) {
        var This=$(this),
        ThiIMG=This.find('img');
        ThiW=This.width();
        This.height(ThiW);
        This.find('a.jia').css({
            'height': ThiW+'px',
            'line-height':ThiW+'px'
        });
        ImgAutoBox(ThiIMG);
    });

}
$(document).ready(function() {
    ImgListBox($('.ImgListBoxs'));
});
var imgList=[];
var myItemIndex=-1;
var myImgCount=0;
function getPics(){
	YW.ajax({
	    url: 'http://192.168.1.222:8081/c/mobile/houseImage/getPublicHouseImage?chuzu='+cz+'&hid='+api.pageParam.id+'&uid='+config.user.uid,
	    method: 'get',
	},function(ret,err){
		if(ret && ret.result==0){
			var template = $('.template');
			var tempHtml = template[0].outerHTML;
			imgList = ret.list;
			for(var i=0;i<imgList.length;i++){
				appendItem(imgList[i], tempHtml , true);
			}
			

		    echo.init({
		      offset: 100,
		      throttle: 250,
		      unload: false,
		      callback: function (element, op) {
		        //console.log(element, 'has been', op + 'ed')
		      }
		    });
		    
		}else{
			blockAlert('加载图片失败');
		}
	});
}

function stringToArray(str){
	var arr = str.split(';');
	var result = [];
	for(var i=0;i<arr.length;i++){
		var path = arr[i];
		if(path==''){
			continue;
		}
		result.push(path);
	}
	return result;
}
function appendItem(imgObj , tempHtml ,lazy){
	var tmp = $(tempHtml);
	tmp.removeClass('hidden');
	tmp.removeClass('template');
	tmp.find('ul').attr('path' , imgObj.path);
	if(imgObj.path){
		var count=0;
		var arr = stringToArray(imgObj.path);
		for(var i=0;i<arr.length;i++){
			var path = arr[i];
			if(path==''){
				continue;
			}
			count++;
			//blockAlert(tmp.find('ul'));
			var offset = i;
			if(imgObj.uid==config.user.uid){
				offset = myImgCount+i;
			}
			if(lazy){
				tmp.find('ul').append('<li onclick="showBigImage(this,'+imgObj.uid+' , '+offset+');"><a href="#" class=""><img src="../images/blank.gif" data-echo="http://192.168.1.222/zjb_house_images/'+hid+'/'+imgObj.uid+'/'+path+'.t.jpg" alt=""></a></li>');
			}else{
				tmp.find('ul').append('<li onclick="showBigImage(this,'+imgObj.uid+' , '+offset+');"><a href="#" class=""><img src="http://192.168.1.222/zjb_house_images/'+hid+'/'+imgObj.uid+'/'+path+'.t.jpg" alt=""></a></li>');
			}
			
		}
		if(imgObj.uid==config.user.uid){
			if($('.myItem').length>0){
				var liList = tmp.find('ul').children();
				for(var i=0;i<liList.length;i++){
					$('.myItem').find('ul').append(liList[i]);
				}
				myImgCount+=count;
				$('.myItem').find('.count').text(myImgCount);
				//修改 ul path属性
				var allPath = $('.myItem').find('ul').attr('path');
				allPath+= imgObj.path;
				$('.myItem').find('ul').attr('path' , allPath);
			}else{
				tmp.addClass('myItem');
				tmp.find('.uname').text('我的照片');	
				$('#mainer').prepend(tmp);
				myImgCount = count;
				tmp.find('.count').text(count);
			}
			
		}else{
			tmp.find('.uname').text(imgObj.uname);
			tmp.find('.count').text(count);
			$('#mainer').append(tmp);
		}
		
	}
}

function addPics(){
	api.actionSheet({
        buttons:['拍照' , '相册']
    },function(ret,err){
    	//
       if(ret.buttonIndex==1){
    	   api.getPicture({
    		    sourceType: 'camera',
    		    encodingType: 'jpg',
    		    mediaValue: 'pic',
    		    destinationType: 'url',
    		    allowEdit: false,
    		    quality: 75,
    		    targetWidth:1080,
    		    saveToPhotoAlbum: true
    		}, function(ret, err){ 
    		    //blockAlert(JSON.stringify(ret));
    		    if(ret.data!=""){
        	    	//添加到页面显示
    		    	var paths=[];
    		    	paths.push(ret.data);
    		    	uploadImages(paths);
    		    }
    		});
       }else if(ret.buttonIndex==2){
    	   api.getPicture({
   		    sourceType: 'album',
   		    encodingType: 'jpg',
   		    mediaValue: 'pic',
   		    destinationType: 'url',
   		    allowEdit: false,
   		    quality: 75,
   		 	targetWidth:1080,
   		    saveToPhotoAlbum: true
   		}, function(ret, err){ 
   		    //blockAlert(JSON.stringify(ret));
   		    if(ret.data!=""){
       	    	//添加到页面显示
   		    	var paths=[];
   		    	paths.push(ret.data);
   		    	uploadImages(paths);
   		    }
   		});
       }
    });
}
var config;
var hid;
var cz=0;
apiready=function(){
	hid = api.pageParam.id;
	if(api.pageParam.isChuzu){
		cz=1;
	}
	getConfig(function(cfg){
		config = cfg;
		getPics();
		
	});
}
function uploadImages(paths){
	YW.ajax({
	    url: 'http://192.168.1.222:8081/c/mobile/houseImage/setPublicHouseImage?chuzu='+cz+'&hid='+hid+'&uid='+config.user.uid,
	    method: 'post',
	    timeout: 30,
	    dataType: 'json',
	    data:{
	        values: {path: paths.join()},
	        files: {file: paths}
	    }
	},function(ret,err){
		if(ret && ret.result==0){
			alert('上传成功');
			//添加到本地
			var template = $('.template');
			var tempHtml = template[0].outerHTML;
			var imgObj = JSON.parse('{}');
			imgObj.path = ret.serverPathList;
			imgObj.uid = config.user.uid;
			appendItem(imgObj , tempHtml , false);
		}else{
			blockAlert('上传失败');
		}
	});
}

function showBigImage(li , picUid , activeIndex){
	var path = $(li).parent().attr('path');
    var obj = api.require('imageBrowser');
    var tmp = path.split(';');
    var arr = [];
    for(var i=0;i<tmp.length;i++){
    	if(tmp[i]==""){
    		continue;
    	}
    	arr.push('http://192.168.1.222/zjb_house_images/'+hid+'/'+picUid+'/'+tmp[i]);
    }
    obj.openImages({
        imageUrls: arr,
        activeIndex: activeIndex,
        showList:false
    });
}
</script>
</head>
<body>
<div  id="wrap" class="bodyer pic up content bodyer">
	<div id="header" class="header">
        <span class="left" onclick="closexx();">
            <a href="#" class="btns"><i class="iconfont">&#xe628;</i></a>
            <h2>图片跟进</h2>
        </span>
        <span id="title" class="conter"></span>
        <span class="right">
            <a href="#" class="btns" onclick="addPics()"><i class="iconfont">&#xe6b9;</i></a>
        </span>
    </div>
    <div id="mainer" class="mainer">
        
    </div>
</div>
 
 <div class="wrap bt5 template hidden">
    <h3 class="h3"><span class="fr">共<span class="count">4</span>张</span><span class="uname">我上传的图片</span></h3>
    <ul class="ImgListBoxs L4">
    </ul>
</div>
</body>
</html>