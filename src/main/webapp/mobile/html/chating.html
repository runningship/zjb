<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
<title>chat</title>
<meta name="description" content="">
<meta name="keywords" content="">
<link href="../css/reset.css" rel="stylesheet">
<link href="../css/style.css" rel="stylesheet">
<script src="../js/jquery.min.js" type="text/javascript"></script>
<script src="../js/layer/layer.js" type="text/javascript"></script>
<script src="../js/javascript.js" type="text/javascript"></script>
</head>
<body>
<div id="wrap" class="bodyer chat">
    <div id="header" class="header">
        <span class="left">
            <a href="#" class="btns"><i class="iconfont">&#xe635;</i></a>
            <h2>你妹妹们</h2>
        </span>
        <span class="right">
            <a href="#" class="btns" id="s"><i class="iconfont">&#xe69b;</i></a>
            <a href="#" class="btns" id="s"><i class="iconfont">&#xe602;</i></a>
            <a href="#" class="btns" id="s"><i class="iconfont">&#xe6c3;</i></a>
        </span>
    </div>
    <div id="mainer" class="mainer">
        <ul class="chatList ing">
            <li class="Y">
                <div class="A">
                    <span>船</span>
                </div>
                <div class="B">
                    <strong>新船</strong>
                    <p>你瞅啥？</p>
                </div>
            </li>
            <li class="M">
                <div class="B">
                    <strong>御龙</strong>
                    <p>瞅你咋地~</p>
                </div>
                <div class="A">
                    <span>龙</span>
                </div>
            </li>
            <li class="Y">
                <div class="A">
                    <span>船</span>
                </div>
                <div class="B">
                    <strong>新船</strong>
                    <p>再瞅一个试试~</p>
                </div>
            </li>
            <li class="M">
                <div class="B">
                    <strong>御龙</strong>
                    <p>试试<br>就试试~</p>
                </div>
                <div class="A">
                    <span>龙</span>
                </div>
            </li>
            <li class="T">
                <div class="time">2015-11-16</div>
            </li>
            <li class="Y">
                <div class="A">
                    <span>船</span>
                </div>
                <div class="B">
                    <strong>新船</strong>
                    <p>你瞅啥？</p>
                </div>
            </li>
            <li class="M">
                <div class="B">
                    <strong>御龙</strong>
                    <p>瞅你咋地~</p>
                </div>
                <div class="A">
                    <span>龙</span>
                </div>
            </li>
            <li class="Y">
                <div class="A">
                    <span>船</span>
                </div>
                <div class="B">
                    <strong>新船</strong>
                    <p>再瞅一个试试~</p>
                </div>
            </li>
            <li class="M">
                <div class="B">
                    <strong>御龙</strong>
                    <p><img src="../images/3.jpg" class="face"><img src="../images/3.jpg">试试<br>就试试~就试试~就试试~就试试~就试试~就试试~就试试~就试试~就试试~就试试~</p>
                </div>
                <div class="A">
                    <span>龙</span>
                </div>
            </li>
            <li class="T">
                <div class="fontnum">0</div>
            </li>
        </ul>
    </div>
    <div class="footer">
        <div class="chatBox" >
            <div class="l"><a href="#" class="btns btnExp"><i class="iconfont">&#xe65c;</i></a></div>
            <div class="c content" id="content" contenteditable="true"></div>
            <div class="r"><a href="#" class="btns submit" id="submit">发送</a></div>
        </div>
        <div class="chatExpBox">
            <ul class="expList clearfix">
                <li><img src="../images/3.jpg" alt=""></li>
                <li><img src="../images/4.png" alt=""></li>
            </ul>
        </div>
    </div>
</div>
<script type="text/javascript">
/* gotoScroll */
function scrollTo(a,t,callback){
    if(!a){a=$('.mainer')}
    if(!t){t=300}
    var a=a,
    t=t;
    scrollTops=a.children(0).innerHeight() - a.innerHeight();
    a.animate({scrollTop: scrollTops},t,callback);
}
/* Hv action */
function setHvData(name,value){
    if(window.localStorage){
        localStorage.setItem(name,value);
    }else{
        alert('不支持？');
    }
}
function getHvData(name){
    if(window.localStorage){
        return localStorage.getItem(name);
    }else{
        alert('不支持？');
    }
}
function reHvData(name){
    if(window.localStorage){
        return localStorage.removeItem(name);
    }else{
        alert('不支持？');
    }
}
/* 实时备份输入框内容 */
function contentIndexIng(){
    $('.content').on('input',function(){
        setHvData('me-you',$(this).html())
    })
}
/* 读取用户信息并显示在消息区 */
function contentSetVal(){
    var val=getHvData('me-you');
    if(val){$('.content').html(val)}
}
/* 删除用户信息 */
function contentReVal(){
    reHvData('me-you');
}

/* 判断文本框获取焦点 */
function ifContFocus(){
    var C=$('.content'),
    R=$('.submit');
    C.on('input',function(){
        if($(this).text()){
            R.addClass('focus');
        }else{
            R.removeClass('focus');
        }
    })
    if(C.text()){
        R.addClass('focus');
    }else{
        R.removeClass('focus');
    }
    C.focus();
}
$(document).ready(function() {

ifContFocus();
scrollTo();

contentIndexIng();
contentSetVal();
});


/* 聊天功能  */
var myName='御龙',
myFace='龙',
youName='',
youFace='';
function setChatList(v){
var str='<li class="M">'
    +'<div class="B">'
    +'<strong>'
    +myName
    +'</strong>'
    +'<p>'
    +v
    +'</p>'
    +'</div>'
    +'<div class="A">'
    +'<span>'
    +myFace
    +'</span>'
    +'</div>'
    +'</li>';
    return str;
}
$(document).on('click touch', '.submit', function(event) {
    var Thi=$(this),
    content=$('.content'),
    contentVal=content.text();
    if(contentVal){
        //layer.msg(content.val());
        var EnCodeVal=contentVal//HtmlEncode(contentVal);
        alert(EnCodeVal)
        $('.mainer').children(0).append(setChatList(EnCodeVal))

        content.text('');
        scrollTo();
        contentReVal();
    }
    event.preventDefault();
    /* Act on the event */
});





/* 表情图片区 */
function insertHtmlAtCaret(html) {
    if(html){
    var html=html;
    var sel, range;
    if (window.getSelection) {
        // IE9 and non-IE
        sel = window.getSelection();
        if (sel.getRangeAt && sel.rangeCount) {
            range = sel.getRangeAt(0);
            range.deleteContents();
            // Range.createContextualFragment() would be useful here but is
            // non-standard and not supported in all browsers (IE9, for one)
            var el = document.createElement("div.content");
            el.innerHTML = html;
            var frag = document.createDocumentFragment(), node, lastNode;
            while ( (node = el.firstChild) ) {
                lastNode = frag.appendChild(node);
            }
            range.insertNode(frag);
            // Preserve the selection
            if (lastNode) {
                range = range.cloneRange();
                range.setStartAfter(lastNode);
                range.collapse(true);
                sel.removeAllRanges();
                sel.addRange(range);
            }
        }
    }
    }
}
$(document).on('click touch', function(event) {
    $('.chatExpBox').removeClass('show');
});
$(document).on('click touch', '.btnExp,.chatExpBox', function(event) {
    var Thi=$(this),
    expBox=$('.chatExpBox'),
    content=$('.content');
    if(!expBox.hasClass('show')){
        expBox.addClass('show');
    }
    return false;
    event.preventDefault();
    /* Act on the event */
});
$(document).on('click touch', '.chatExpBox img', function(event) {
    var Thi=$(this),
    content=$('.content'),
    faces=Thi.prop("outerHTML");
//    layer.msg(Thi.attr('src'));
//content.val(Thi.prop("outerHTML"))
insertHtmlAtCaret(faces)
    return false;
    event.preventDefault();
    /* Act on the event */
});




</script>
</body>
</html>