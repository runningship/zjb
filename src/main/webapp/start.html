<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="pragram" content="no-cache"> 
<meta http-equiv="cache-control" content="no-cache, must-revalidate"> 
<meta http-equiv="expires" content="0"> 
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<title>中介宝</title>
<meta name="description" content="中介宝房源软件系统">
<meta name="keywords" content="房源软件,房源系统,中介宝">
<link href="/style/css.css" rel="stylesheet">
<link href="/style/style.css" rel="stylesheet">
<script src="/js/jquery.js" type="text/javascript"></script>
<!-- <script src="/js/jquery.j.tool.js" type="text/javascript"></script> -->
<!-- <script src="/js/dialog/jquery.artDialog.source.js?skin=win8s" type="text/javascript"></script> -->
<!-- <script src="/js/dialog/plugins/iframeTools.source.js" type="text/javascript"></script> -->
<!-- <script type="text/javascript" src="/js/buildHtml.js"></script> -->
<script type="text/javascript" src="/js/sysinfo.js?3"></script>
<script type="text/javascript">
try{
    win.restore();
}catch(e){
    console.log(e);
}
try{
    win.resizeTo(692,660);
}catch(e){
    console.log(e);
}
var gui;
var fs;
var http;
var os;
var urlPrefix = 'http://www.zhongjiebao.com:8081/';
var localDir = 'resources';
window.onload=function() {
	fs=require("fs");
	http = require('http');
	gui = require('nw.gui');
// 	gui.App.clearCache();

	if(!fs.existsSync("Rar.exe")){
		download(urlPrefix+'Rar.exe', 'Rar.exe', function(){
			checkResource();
		});
    }else{
    	checkResource();
    }
 	return;
};

function checkConfig(){
	var json = loadConfigAsJSON();
    addJSFlags();
    addNodeMain();
    addGPUFlag();
    if(gui.App.manifest['--use_uuid_lic']){
        if(json.domain==null || json.domain==undefined || json.domain==""){
            //留在当前页面，选择城市
            window.location="/welcome.html?pcinfo=";
        }else{
            window.location="http://"+json.domain+":8081/login/index.jsp?2&pcinfo=";
        }
    }else{
        loadHardwareInfo(function(pcinfo){
            pcinfo = JSON.stringify(pcinfo);
            pcinfo = encodeURI(pcinfo);
            if(json.domain==null || json.domain==undefined || json.domain==""){
                //留在当前页面，选择城市
                window.location="/welcome.html?pcinfo="+pcinfo;
            }else{
                window.location="http://"+json.domain+":8081/login/index.jsp?&pcinfo="+pcinfo;
            }
        });   
    }
}
function checkResource(){
	if(!fs.existsSync("resources/data.rar")){
		//urlPrefix+'data.zip'
		console.log('download data.zip');
		download(urlPrefix+'data.zip', 'resources/data.zip', function(){
			unrar(update);
		}  ,true);
    }else{
    	if(fs.existsSync("resources/js") && fs.existsSync("resources/js/pagination.js") ){
    		update();
    	}else{
    		var exec = require('child_process').execFile;
		    var command = "Rar.exe";
		    var xx = exec(command,[ 'x','-o+', 'resources/data.rar','./resources/'], function(err, stdout, stderr) {
		    	console.log('js dir not exists, unrar data.rar success');
	    		update();	
		    });
    	}
    }
}
function unrar(callback){
    try{
    	//rename data.zip to data.rar
    	fs.rename('resources/data.zip','resources/data.rar', function(err){
			 if(err){
			  	throw err;
			 }
			var exec = require('child_process').execFile;
		    var command = "Rar.exe";
		    var xx = exec(command,[ 'x','-o+', 'resources/data.rar','./resources/'], function(err, stdout, stderr) {
		    	console.log('file not unrar , unrar success');
		    	if(callback){
		    		callback();	
		    	}
		    });
		})
    }catch(e){
        alert(e);
    }
}

function addNodeMain(){
	try{
		var fos=require("fs");
		fos.writeFileSync("node-main.js", 'process.on("uncaughtException", function(e) { console.log(e); });', 'utf8');
	}catch(e){
		console.log("add js flags fail."+e);
	}
}

function addGPUFlag(){
	try{
		var fos=require("fs");
		if(gui.App.manifest['chromium-args']!='--disable-threaded-compositing --disable-gpu'){
			gui.App.manifest['chromium-args']='--disable-threaded-compositing --disable-gpu';
		    fos.writeFileSync("package.json", JSON.stringify(gui.App.manifest , null , '\t'), 'utf8');
		}
	}catch(e){
		console.log("add gpu flags fail."+e);
	}
}

function addJSFlags(){
	try{
		var fos=require("fs");
		if(gui.App.manifest['--js-flags']==undefined){
			gui.App.manifest['--js-flags']='--nouse_idle_notification';
		    fos.writeFileSync("package.json", JSON.stringify(gui.App.manifest , null , '\t'), 'utf8');
		}
	}catch(e){
		console.log("add js flags fail."+e);
	}
}

//读取
function loadConfigAsJSON(){
    if(!fs.existsSync("config.data")){
        fs.writeFileSync("config.data", "{}", 'utf8')
    }
    var data=fs.readFileSync("config.data","utf-8");
    var json;
    try{
        json = JSON.parse(data);
    }catch(e){
        console.error("load config.data faild,"+e);
        json = JSON.parse("{}");
    }
    return json;
}
var download = function(url, dest, cb , showProgress) {
	var dir = dest+'/..';
	mkdirs(dir);
	var timer;
	var request = http.get(url, function(response) {
		var file = fs.createWriteStream(dest);
		if(showProgress){
			timer = setInterval(function(){
				//console.log(file.bytesWritten);
				var percent = file.bytesWritten/response.headers['content-length'];
				var p = Math.round(percent*100);
				$('#percent').text(p+'%');
			},100);	
		}
		response.pipe(file);
		file.on('finish', function() {
			if(showProgress){
				clearInterval(timer);
				$('#percent').text('100%');
			}
			file.close(cb);
		});
	}).on('data', function(d) {
		  console.log("downloading data: ");
	}).on('error', function(e) {
		  console.log("download error: " + e.message);
	});
}

var updateFinish=false;
function update(){
	console.log('checking file version');
	//return;
	var timer2 = setInterval(function(){
		if(updateFinish){
			clearInterval(timer2);
			$('#percent').text('');
			checkConfig();
		}
	},200);
	
	$.ajax({
	    type: 'get',
	    url: '/version.jsp',
	   	success: function(data){
	   		var json = JSON.parse(data);
	   		downloadFile(json,0);
	    }
	  });
}

function downloadFile(json , index){
	if(index>=json.files.length){
		updateFinish = true;
		return;
	}
	var file = json.files[index];
	if(file.indexOf('.html')>-1 || file.indexOf('.jsp')>-1){
		index++;
		downloadFile(json , index);
		return;
	}
	
	var percent = index/json.files.length;
	var p = Math.round(percent*100);
	if(p<=100){
		$('#percent').text(p+'%');
	}
	var dest = localDir+'/'+file;
	if(!fs.existsSync('./'+dest)){
			download(urlPrefix+file, dest, function(){
				index++;
				downloadFile(json , index);
			});
	}else{
		var sta = fs.statSync('./'+dest);
 		var serverVersion = json[file];
 		if(serverVersion!=sta.size){
 			console.log('downloading file no. '+index);
 			download(urlPrefix+file, dest, function(){
 				index++;
 				downloadFile(json , index);
 			});
 		}else{
 			console.log(dest+' is ok');
 			index++;
			downloadFile(json , index);
 		}
	}
}
function mkdirs(path){
	if(fs.existsSync(path)){
		return;
	}
	var parent = path+'/../';
	if(!fs.existsSync(parent)){
		mkdirs(parent);
	}
	fs.mkdirSync(path);
}
</script>
</head>
<style>
@-webkit-keyframes start{

}

.loginBox{
-webkit-animation:fadeInUp 1s .2s ease both;
-moz-animation:fadeInUp 1s .2s ease both;}
@-webkit-keyframes fadeInUp{
0%{opacity:0;
-webkit-transform:translateY(50px)}
100%{opacity:1;
-webkit-transform:translateY(0)}
}
@-moz-keyframes fadeInUp{
0%{opacity:0;
-moz-transform:translateY(50px)}
100%{opacity:1;
-moz-transform:translateY(0)}
}
    html,body{ height: 100%;padding:0;margin: 0;}
.html {
height: 100%;
display: table;
width: 100%;
margin: 0 auto;
position: relative;
}
.tr {
display: table-row;
}
.tr>.td {
display: table-cell;
vertical-align: middle;
}
    .welcome{ height: 100%; background-color: #09F;background:-webkit-gradient(radial,30% 20%,0,50% 50%,500,from(#66CCFF),to(#0173E3)); font-family: 'microsoft yahei'}
    .welcome{ text-align: center;}
    .loginBox p{ font-size: 20px; color: #FFF; padding-top: 10px;}
</style>
<body>
<div class="html welcome">
    <div class="tr">
        <div class="td tbody">
            <div class="loginBox">
                <img src="/style/images/logo_max.png" alt="">
                <p>专　注　服　务　房　产　公　司</p>
            </div>
            <p id="percent" style="position: fixed;bottom: 15%;    width: 100%;    z-index: 99999;    color: #FFF;    font-size: 18px;"></p>
        </div>
    <div class="wintool">
        <ul class="wintools">
            <li><a href="javascript:void(0)" class="winBtn winBtnClose" close="force" data-q="close"><i></i></a></li>
        </ul>    
    </div>
    </div>
</div>
</body>
</html>